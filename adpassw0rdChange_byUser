[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

Try 
{   
    #$ChangePWSEvent.message = Get-WinEvent  -FilterHashtable @{LogName='Security';Id=4740} -ErrorAction Stop | Sort-Object -Property TimeCreated -Descending | select -First 1
 
    $ChangePWDEvent = Get-WinEvent -FilterHashtable @{LogName="Security";Id=4723} -MaxEvents 1
    $eventXML = [xml]$ChangePWDEvent.ToXml()
    $date = $ChangePWDEvent.TimeCreated
    $eventdate = get-date $date -Format "yyyy/MM/dd HH:mm"
    $targetuser = $eventXML.event.EventData.Data[0].'#text'
    $Changedby = $eventXML.event.EventData.Data[4].'#text'
    $targetuserDisplayName = (Get-ADUser -Identity $targetuser|Select-Object -ExpandProperty Name) #.replace(' ','') -split '[ /()]')[1]
#    $ChangedbyDisplayName = Get-ADUser -Identity $Changedby|Select-Object -ExpandProperty Name

    $email = Get-ADUser -Identity $targetuser -Properties EmailAddress | Select-Object emailaddress -ErrorAction stop
  if (!($email.emailaddress))
  {
	$email.emailaddress = "youremail"  
  }
} 
Catch  
{           
    $targetuser = "Not Found"
	$email = "mis@everfocus.com"  
 
}#end catch    
 
$username   = 'youremail'
$password   = 'yourpassw0rd'
$secstr     = ConvertTo-SecureString $password -AsPlainText -Force


$hash = @{
    from       = "o365smtp@everfocus.com"
	to         = $email.emailaddress
    bcc        = "youremail"
    subject =  "【提醒】$targetuserDisplayName 密碼自行變更通知 !!"
    smtpserver = "yoursmtp"
    port       = "587"
	#importance = “High”
    body       = @"
<HTML>
<P><FONT face=微軟正黑體>Dear $targetuserDisplayName,</FONT></P>
<P><FONT face=微軟正黑體><FONT color=#ff0000>這是來自 IT 管理員的重要訊息!!<BR></FONT>我們非常重視您的安全和隱私。</FONT></P>
<P><FONT face=微軟正黑體>作為系統日常監控的一部分，</FONT><FONT face=微軟正黑體>發現您的密碼已自行於 $eventdate 進行更改。<BR>如果您未進行此操作，請立即聯絡IT部門，謝謝~<BR></P>
</HTML>
"@
    BodyAsHtml = $true
    credential = new-object -typename System.Management.Automation.PSCredential -argumentlist $username, $secstr
    usessl     = $true
	Encoding   = New-Object System.Text.UTF8Encoding
    
}
 
Send-MailMessage @hash
